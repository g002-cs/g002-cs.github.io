<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>必修課程輸入</title>
<style>
  body { margin: 0; font-family: Arial, sans-serif; background-color: #fff; }
  .navbar { background-color: #98B1E0; display: flex; align-items: center; padding: 10px 20px; }
  .navbar img { width: 40px; height: 40px; margin-right: 20px; }
  .navbar a { text-decoration: none; color: black; margin-right: 100px; font-weight: bold; }
  .navbar a:hover { text-decoration: underline; }
  .navbar a:first-child { margin-right:50px; }

  .student-info { margin: 20px 40px; font-size: 16px; color: #333; }

  .left-arrow { display: inline-block; background-color: #98B1E0; padding: 15px 25px;
    clip-path: polygon(0 50%, 20% 0, 100% 0, 100% 100%, 20% 100%); font-size: 18px; color: black; margin: 10px 0 20px 40px; }

  .content { margin: 20px 40px; }
  .filters { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
  select { padding: 10px 15px; background-color: #98B1E0; border: none; border-radius: 5px; font-size: 16px; }

  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border-bottom: 1px solid #ccc; padding: 15px; text-align: center; font-size: 16px; }
  th { background-color: #f0f0f0; }

  input[type="checkbox"] {
    appearance: none; width: 24px; height: 24px; border: 2px solid #98B1E0; border-radius: 6px;
    background-color: #fff; cursor: pointer; position: relative;
  }
  input[type="checkbox"]:checked { background-color: #98B1E0; border-color: #98B1E0; }
  input[type="checkbox"]:checked::after {
    content: '✔'; position: absolute; top: -2px; left: 4px; font-size: 18px; color: #fff;
  }

  input[type="text"], input[type="number"] {
    padding: 10px; font-size: 16px; border: none; background-color: #E0E6F6; border-radius: 5px;
  }

  button { background-color: #98B1E0; border: none; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; }
  button:hover { background-color: #7DA6D1; }
</style>
</head>
<body>

<script>
  // 取得 URL 參數
  const params = new URLSearchParams(window.location.search);
  const studentId = params.get('studentId');
  const group = params.get('group');
  const year = params.get('year');

  const allowedGroups = ['行銷與數位經營組','服務創新與創業組','尚未分組'];
  if (!studentId || !allowedGroups.includes(group)) {
    window.location.href = 'login.html';
  }

  // 動態帶參數
  function withParams(page, extra = '') {
    let base = `${page}?studentId=${encodeURIComponent(studentId)}&group=${encodeURIComponent(group)}&year=${encodeURIComponent(year)}`;
    if (extra) base += `&${extra}`;
    return base;
  }
</script>

<!-- 導覽列 -->
<div class="navbar">
  <a id="homeLink" href="#"><img src="https://cdn-icons-png.flaticon.com/512/25/25694.png" alt="Home"></a>
  <a id="introLink" href="#">系統介紹</a>
  <a id="requiredLink" href="#">必修科目表</a>
  <a id="courseLink" href="#">課程輸入</a>
  <a id="creditsLink" href="#">學分計算</a>
</div>

<!-- 內容 -->
<div class="content" style="margin:30px 5px;">
  <div class="left-arrow">必修課程輸入</div>
  <div class="student-info">學號：<span id="studentIdDisplay"></span></div>

  <div class="content">
    <div class="filters">
      <label for="typeSelect">單/選/通：</label>
      <select id="typeSelect">
        <option value="必修" selected>必修</option>
        <option value="選修">選修</option>
        <option value="通識">通識</option>
      </select>

      <label for="categorySelect">科目分類：</label>
      <select id="categorySelect">
        <option value="基礎課程">基礎課程</option>
        <option value="系必修">系必修</option>
        <option value="組必修">組必修</option>
      </select>
    </div>

    <table>
      <thead>
        <tr><th>已修</th><th>課程名稱</th><th>學分數</th></tr>
      </thead>
      <tbody id="courseTableBody"></tbody>
    </table>
  </div>
</div>

<script>
  // 導覽列連結
  document.getElementById('homeLink').href = withParams('login.html');
  document.getElementById('introLink').href = withParams('page2.html');
  document.getElementById('requiredLink').href = withParams('required.html');
  document.getElementById('courseLink').href = withParams('course.html');
  document.getElementById('creditsLink').href = withParams('credits.html');

  // 顯示學號
  document.getElementById('studentIdDisplay').textContent = studentId;

  const tbody = document.getElementById('courseTableBody');
  const typeSelect = document.getElementById('typeSelect');
  const categorySelect = document.getElementById('categorySelect');
  const storageKey = `required_${studentId}`;
  let courses = [];

  async function loadCSV() {
    const res = await fetch('database.csv');
    const text = await res.text();
    const lines = text.split('\n').slice(2);
    courses = lines.map(line => {
      const [CNO,SNO,CTITLE,CID,CREDIT] = line.split(',');
      if (!SNO) return null;
      let category = '';
      if (SNO === 'RD') category = '系必修';
      else if (SNO.startsWith('RG')) {
        if (group === '行銷與數位經營組' && SNO === 'RG-M') category = '組必修';
        if (group === '服務創新與創業組' && SNO === 'RG-S') category = '組必修';
      }
      else if (SNO === 'RS') category = '基礎課程';
      if (!category) return null;
      return { name: CTITLE, credits: Number(CREDIT), type: '必修', category };
    }).filter(Boolean);
    renderTable();
  }

  function renderTable() {
    tbody.innerHTML = '';
    const type = typeSelect.value;
    const category = categorySelect.value;
    const saved = JSON.parse(localStorage.getItem(storageKey) || '[]');
    courses.filter(c => c.type === type && c.category === category).forEach(c => {
      const isChecked = saved.some(item => item.name === c.name && item.category === c.category);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="checkbox"
                   data-name="${c.name}"
                   data-credits="${c.credits}"
                   data-category="${c.category}"
                   ${isChecked ? 'checked' : ''}></td>
        <td>${c.name}</td>
        <td>${c.credits}</td>
      `;
      tbody.appendChild(row);
    });
    tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', saveSelection);
    });
  }

  function saveSelection() {
    const saved = JSON.parse(localStorage.getItem(storageKey) || '[]');
    const currentCategory = categorySelect.value;
    const filtered = saved.filter(item => item.category !== currentCategory);
    const selected = [];
    document.querySelectorAll('#courseTableBody input[type="checkbox"]:checked').forEach(cb => {
      selected.push({ name: cb.dataset.name, credits: Number(cb.dataset.credits), category: cb.dataset.category });
    });
    const newData = [...filtered, ...selected];
    localStorage.setItem(storageKey, JSON.stringify(newData));
  }

  typeSelect.addEventListener('change', function() {
    const value = this.value;
    if (value === '必修') window.location.href = withParams('required-course.html');
    if (value === '選修') window.location.href = withParams('elective-course.html');
    if (value === '通識') window.location.href = withParams('general-course.html');
  });
  categorySelect.addEventListener('change', renderTable);

  loadCSV();

  // ✅ 新增：根據 URL tab 參數自動設定分類
  window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get('tab');
    if (tab) {
      // 如果有 tab，就自動選擇該分類
      typeSelect.value = '必修';
      categorySelect.value = tab;
      renderTable();
    }
  });
</script>

</body>
</html>
