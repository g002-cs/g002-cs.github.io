<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>選修課程輸入</title>
<style>
  body { margin: 0; font-family: Arial, sans-serif; background-color: #fff; }

  /* 導覽列 */
  .navbar { background-color: #98B1E0; display: flex; align-items: center; padding: 10px 20px; }
  .navbar img { width: 40px; height: 40px; margin-right: 20px; }
  .navbar a { text-decoration: none; color: black; margin-right: 100px; font-weight: bold; }
  .navbar a:hover { text-decoration: underline; }
  .navbar a:last-child { margin-right: 1; }
  .navbar a:first-child { margin-right:50px; }

  .left-arrow { display: inline-block; background-color: #98B1E0; padding: 15px 25px;
    clip-path: polygon(0 50%, 20% 0, 100% 0, 100% 100%, 20% 100%);
    font-size: 18px; color: black; margin: 20px 0 20px 40px; }

  .content { margin: 20px 40px; }
  .filters { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
  select { padding: 10px 15px; background-color: #98B1E0; border: none; border-radius: 5px; font-size: 16px; }

  /* 主區塊 */
  .main-area { display: flex; justify-content: space-between; gap: 30px; }
  .course-list { width: 50%; background-color: #f5f5f5; padding: 20px; border-radius: 8px; }
  .course-list h3 { margin-bottom: 10px; }

  .input-area { display: flex; flex-direction: column; gap: 15px; }
  label { font-size: 16px; }
  input { padding: 10px; font-size: 16px; border: none; background-color: #ddd; border-radius: 5px; }
  button { background-color: #98B1E0; border: none; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; }
  button:hover { background-color: #7EA5D6; }

  /* 調整刪除按鈕樣式與位置 */
  #internalCourseList li,
  #externalCourseList li {
    display: flex;
    align-items: center;
    justify-content: space-between; /* 讓刪除按鈕靠右 */
    padding: 5px 0;
  }
 
  #internalCourseList li button,
  #externalCourseList li button {
    background-color: #ff4d4d; /* 紅色 */
    color: white;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    margin-left: 10px; /* 與文字保持距離 */
  }

  #internalCourseList li button:hover,
  #externalCourseList li button:hover {
    background-color: #e60000; /* hover 更深紅 */
  }

  /* SD 課程表 */
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border-bottom: 1px solid #ccc; padding: 10px; text-align: center; font-size: 16px; }
  th { background-color: #eaeaea; }
  input[type="checkbox"] {
    appearance: none; width: 20px; height: 20px; border: 2px solid #98B1E0; border-radius: 4px; background-color: #fff; cursor: pointer; position: relative;
  }
  input[type="checkbox"]:checked { background-color: #98B1E0; border-color: #98B1E0; }
  input[type="checkbox"]:checked::after {
    content: '✔'; position: absolute; top: -2px; left: 3px; font-size: 14px; color: #fff;
  }
</style>
</head>
<body>

<!-- 導覽列 -->
<div class="navbar">
  <a id="homeLink" href="#"><img src="https://cdn-icons-png.flaticon.com/512/25/25694.png" alt="Home"></a>
  <a id="introLink" href="#">系統介紹</a>
  <a id="requiredLink" href="#">必修科目表</a>
  <a id="courseLink" href="#">課程輸入</a>
  <a id="creditsLink" href="#">學分計算</a>
</div>

<div class="left-arrow">選修課程輸入</div>

<div class="content">
  學號：<span id="studentIdDisplay"></span>

  <div class="filters">
    <label for="typeSelect">單/選/通：</label>
    <select id="typeSelect">
      <option value="必修">必修</option>
      <option value="選修" selected>選修</option>
      <option value="通識">通識</option>
    </select>

    <label for="categorySelect">科目分類：</label>
    <select id="categorySelect">
      <option value="系內選修" selected>系內選修</option>
      <option value="系外選修">系外選修</option>
    </select>
  </div>

  <!-- 系內選修 -->
  <div class="main-area" id="internalSection">
    <div class="course-list">
      <h3>（已輸入課程顯示區）</h3>
      <ol id="internalCourseList"></ol>

      <h3>（SD 課程清單）</h3>
      <table id="sdTable">
        <thead><tr><th>已修</th><th>課程名稱</th><th>學分</th></tr></thead>
        <tbody id="sdTableBody"></tbody>
      </table>
    </div>

    <div class="input-area">
      <label>科目名稱：<input type="text" id="internalCourseName" placeholder="自行輸入"></label>
      <label>學分：<input type="number" id="internalCourseCredits" placeholder="自行輸入"></label>
      <button id="addInternalBtn">確定</button>
    </div>
  </div>

  <!-- 系外選修 -->
  <div class="main-area" id="externalSection" style="display:none;">
    <div class="course-list">
      <h3>（已輸入課程顯示區）</h3>
      <ol id="externalCourseList"></ol>
    </div>

    <div class="input-area">
      <label>科目名稱：<input type="text" id="externalCourseName" placeholder="自行輸入"></label>
      <label>學分：<input type="number" id="externalCourseCredits" placeholder="自行輸入"></label>
      <button id="addExternalBtn">確定</button>
    </div>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const studentId = params.get('studentId');
  const group = params.get('group');
  const year = params.get('year');
  const allowedGroups = ['行銷與數位經營組','服務創新與創業組','尚未分組'];
  if (!studentId || !allowedGroups.includes(group)) window.location.href = 'login.html';

  function withParams(page) {
    return `${page}?studentId=${encodeURIComponent(studentId)}&group=${encodeURIComponent(group)}&year=${encodeURIComponent(year)}`;
  }

  document.getElementById('homeLink').href = withParams('login.html');
  document.getElementById('introLink').href = withParams('page2.html');
  document.getElementById('requiredLink').href = withParams('required.html');
  document.getElementById('courseLink').href = withParams('course.html');
  document.getElementById('creditsLink').href = withParams('credits.html');
  document.getElementById('studentIdDisplay').textContent = studentId;

  const categorySelect = document.getElementById('categorySelect');
  const internalSection = document.getElementById('internalSection');
  const externalSection = document.getElementById('externalSection');

  // 根據 categorySelect 切換顯示
  function updateCategoryDisplay() {
    if (categorySelect.value === '系內選修') {
      internalSection.style.display = 'flex';
      externalSection.style.display = 'none';
    } else {
      internalSection.style.display = 'none';
      externalSection.style.display = 'flex';
    }
  }
  categorySelect.addEventListener('change', updateCategoryDisplay);

  // ======== 根據 URL tab 參數切換子畫面 ========
  const tab = params.get('tab');
  if (tab) {
    // tab 可能值: "系內選修" / "系外選修"
    if (tab === '系內選修' || tab === '系外選修') {
      categorySelect.value = tab;
      updateCategoryDisplay();
    }
  }

  // 儲存用 key
  const internalKey = `elective_internal_${studentId}`;
  const externalKey = `elective_external_${studentId}`;
  const sdKey = `sd_courses_${studentId}`;

  // ==== 系內選修輸入 ====
  const internalList = document.getElementById('internalCourseList');
  const internalName = document.getElementById('internalCourseName');
  const internalCredits = document.getElementById('internalCourseCredits');
  document.getElementById('addInternalBtn').onclick = () => {
    const n = internalName.value.trim(), c = internalCredits.value.trim();
    if (!n || !c) return alert('請輸入完整資訊');
    const li = document.createElement('li');
    li.textContent = `${n}　${c}學分`;
    const del = document.createElement('button');
    del.textContent = '刪除';
    del.onclick = () => { li.remove(); saveCourses(internalKey, internalList); };
    li.appendChild(del);
    internalList.appendChild(li);
    internalName.value = ''; internalCredits.value = '';
    saveCourses(internalKey, internalList);
  };

  // ==== 系外選修輸入 ====
  const externalList = document.getElementById('externalCourseList');
  const externalName = document.getElementById('externalCourseName');
  const externalCredits = document.getElementById('externalCourseCredits');
  document.getElementById('addExternalBtn').onclick = () => {
    const n = externalName.value.trim(), c = externalCredits.value.trim();
    if (!n || !c) return alert('請輸入完整資訊');
    const li = document.createElement('li');
    li.textContent = `${n}　${c}學分`;
    const del = document.createElement('button');
    del.textContent = '刪除';
    del.onclick = () => { li.remove(); saveCourses(externalKey, externalList); };
    li.appendChild(del);
    externalList.appendChild(li);
    externalName.value = ''; externalCredits.value = '';
    saveCourses(externalKey, externalList);
  };

  // ==== 儲存與載入課程 ====
  function saveCourses(key, listEl) {
    const data = [];
    listEl.querySelectorAll('li').forEach(li => {
      const match = li.textContent.replace('刪除','').trim().match(/(.+)\s+(\d+)學分/);
      if (match) data.push({ name: match[1].trim(), credits: Number(match[2]) });
    });
    localStorage.setItem(key, JSON.stringify(data));
  }
  function loadCourses(key, listEl) {
    const data = JSON.parse(localStorage.getItem(key) || '[]');
    data.forEach(c => {
      const li = document.createElement('li');
      li.textContent = `${c.name}　${c.credits}學分`;
      const del = document.createElement('button');
      del.textContent = '刪除';
      del.onclick = () => { li.remove(); saveCourses(key, listEl); };
      li.appendChild(del);
      listEl.appendChild(li);
    });
  }
  loadCourses(internalKey, internalList);
  loadCourses(externalKey, externalList);

  // ==== SD 課程 ====
  async function loadSDCourses() {
    try {
      const res = await fetch('database.csv');
      const text = await res.text();
      const lines = text.split('\n').slice(2);
      const courses = lines.map(line => {
        const [CNO, SNO, CTITLE, CID, CREDIT] = line.split(',');
        if (SNO === 'SD') return { name: CTITLE, credits: Number(CREDIT) };
        return null;
      }).filter(Boolean);
      renderSDCourses(courses);
    } catch (err) { console.error(err); }
  }

  function renderSDCourses(courses) {
    const body = document.getElementById('sdTableBody');
    body.innerHTML = '';
    const saved = JSON.parse(localStorage.getItem(sdKey) || '[]');
    courses.forEach(c => {
      const checked = saved.some(s => s.name === c.name);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><input type="checkbox" data-name="${c.name}" data-credits="${c.credits}" ${checked ? 'checked' : ''}></td>
                      <td>${c.name}</td><td>${c.credits}</td>`;
      body.appendChild(tr);
    });
    body.querySelectorAll('input[type=checkbox]').forEach(cb => cb.addEventListener('change', saveSD));
  }

  function saveSD() {
    const data = [];
    document.querySelectorAll('#sdTableBody input:checked').forEach(cb => {
      data.push({ name: cb.dataset.name, credits: Number(cb.dataset.credits) });
    });
    localStorage.setItem(sdKey, JSON.stringify(data));
  }
  loadSDCourses();

  // ==== 單/選/通切換 ====
  document.getElementById('typeSelect').addEventListener('change', e => {
    const v = e.target.value;
    if (v === '必修') window.location.href = withParams('required-course.html');
    if (v === '選修') window.location.href = withParams('elective-course.html');
    if (v === '通識') window.location.href = withParams('general-course.html');
  });

</script>

</body>
</html>
